<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Savings Account Type</title>
    <link rel="stylesheet" href="/css/analysis-find-account.css">
</head>

<body>
    <div class="header">
        <h1>Analysis</h1>
        <div class="row">
            <h2>Find Account</h2>
            <button type="button" class="btn-CSV" id="csv_button">Export CSV</button>
        </div>
    </div>
    <div>
        <a id="contact-link">
            <button class="button" id="contact-button">Contact</button>
        </a>
    </div>
    <div class="input-container">
        <div class="input-ID">
            <label for="ID_account">ID Account</label>
            <input type="text" class="input-field" id="ID_account" placeholder="MSxxxx">
        </div>
        <div class="input-group">
            <label for="ID_card">ID Card</label>
            <input type="text" class="input-field" id="ID_card" placeholder="012345678911">
        </div>
    </div>
    <div class="input-container-second">
        <div class="input_date_create">
            <label for="date-create">Date Create Account</label>
            <input type="text" class="input-field" id="date-create" placeholder="dd/mm/yyyy" maxlength="10">
        </div>
        <div class="type_of_saving">
            <label for="type-saving">Type of Saving</label>
            <select id="type-saving">
                <option value="">Choose type</option>
                <option value = "non-term">Non-term</option>
            </select>
        </div>
    </div>
    <button type="button" class="btn-primary" id="submit_button">Find</button>

    <div class="table-container">
        <table class="account-table" id="account-table">
            <caption>List of Accounts</caption>
            <thead>
                <tr>
                    <th>No</th>
                    <th>ID Account</th>
                    <th>Type of Saving</th>
                    <th>Customer's name</th>
                    <th>Balance (VND)</th>
                </tr>
            </thead>
            <tbody>
                <!-- Table data will be inserted dynamically -->
            </tbody>
        </table>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Fetch newest accounts on page load
            fetch('/analysis/find-account/getNewestAccountAPI')
                .then(response => response.json())
                .then(data => {
                    if (Array.isArray(data)) {
                        renderTable(data);
                    } else {
                        console.error('Expected an array but received:', data);
                        alert('Unexpected data format received from the server.');
                    }
                })
                .catch(error => console.error('Error fetching newest accounts:', error));

            // Fetch options for type of saving from API
            const selectElement = document.getElementById('type-saving');
            fetch('/analysis/find-account/getTypeAPI')
                .then(response => response.json())
                .then(data => {
                    const existList = new Set();
                    let nonTermAdded = false; // Biến để kiểm tra non-term đã được thêm hay chưa

                    data.forEach(option => {
                        const optionTypeLower = option.type.toLowerCase();

                        // Kiểm tra nếu là non-term và chỉ thêm 1 lần
                        if (optionTypeLower === 'non-term') {
                            if (!nonTermAdded) {
                                const optionElement = document.createElement('option');
                                optionElement.value = option.type;
                                optionElement.textContent = option.type;
                                selectElement.appendChild(optionElement);
                                nonTermAdded = true; // Đánh dấu đã thêm non-term
                            }
                        }
                        // Thêm các loại khác nếu chưa có trong existList
                        else if (!existList.has(optionTypeLower)) {
                            const optionElement = document.createElement('option');
                            optionElement.value = option.type;
                            optionElement.textContent = option.type;
                            selectElement.appendChild(optionElement);
                            existList.add(optionTypeLower); // Lưu vào Set để kiểm tra trùng lặp
                        }
                    });
                })
                .catch(error => console.error('Error fetching options:', error));
        });

        function renderTable(data) {
            const tbody = document.querySelector("#account-table tbody");
            tbody.innerHTML = ""; // Clear existing rows

            data.forEach((item, index) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.id_account}</td>
                    <td>${item.type_of_saving}</td>
                    <td>${item.name}</td>
                    <td>${item.cur_balance}</td>
                `;
                tbody.appendChild(row);
            });

            // Add scroll bar if more than 10 rows
            const tableContainer = document.querySelector(".table-container");
            if (data.length > 10) {
                tableContainer.style.overflowY = "scroll";
            } else {
                tableContainer.style.overflowY = "auto"; // Disable scroll if not needed
            }
        }

        document.getElementById("submit_button").addEventListener("click", function () {
            var idAccount = document.getElementById("ID_account").value;
            var idCard = document.getElementById("ID_card").value;
            var dateCreate = document.getElementById("date-create").value;
            var typeSaving = document.getElementById("type-saving").value;

            // Fetch data based on filters
            fetch(`/analysis/find-account/createReportAPI?id_card=${idCard}&id_account=${idAccount}&date_created_account=${dateCreate}&type_of_saving=${typeSaving}`)
                .then(response => response.json())
                .then(data => {
                    if (Array.isArray(data)) {
                        renderTable(data);
                    } else {
                        console.error('Expected an array but received:', data);
                        alert('Unexpected data format received from the server.');
                    }
                })
                .catch(error => console.error('Error fetching data:', error));
        });

        document.getElementById("csv_button").addEventListener("click", function () {
            const table = document.getElementById("account-table");
            const rows = Array.from(table.querySelectorAll("tr"));
            const csv = rows.map(row => Array.from(row.querySelectorAll("th, td"))
                .map(cell => `"${cell.innerText}"`).join(",")).join("\n");

            const csvBlob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const csvUrl = URL.createObjectURL(csvBlob);
            const link = document.createElement("a");
            link.href = csvUrl;
            link.download = "accounts_report.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    </script>
</body>

</html>
