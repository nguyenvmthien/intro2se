<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Savings Account Type</title>
    <link rel="stylesheet" href="/css/analysis-monthly-report.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="header">
        <h1>Analysis</h1>
        <div class="row">
            <h2>Monthly Report</h2>
            <button type="button" class="btn-CSV" id="csv_button" disabled>Export CSV</button>
        </div>
    </div>
    <div>
        <a id="contact-link">
            <button class="button" id="contact-button">Contact</button>
        </a>
    </div>
    <div class="filters">
        <div class="filter-group">
            <label for="month-report">Month</label>
            <input type="month" id="month-report" name="month-report" value="2024-01" onfocus="this.value=''" onblur="if(this.value===''){this.value='2024-01'}">
        </div>
        <div class="filter-group">
            <label for="type-saving">Type of Saving</label>
            <select id="type-saving" name="type-saving">
                <option value="">Select Type</option>
            </select>
        </div>
    </div>
    <button class="create_button" id="create">Create Report</button>
    <div class="table-container">
        <div class="caption-container">
            <span class="table-title">Monthly Account Activity Report</span>
            <div class="filter-info">
                <span class="filter-label" id="type-saving-info">Type of Savings: --</span>
                <span class="filter-label" id="month-info">Month: --</span>
            </div>
        </div>
        <table class="account-table">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Day</th>
                    <th>Number of New Accounts</th>
                    <th>Number of Closed Accounts</th>
                    <th>Difference</th>
                </tr>
            </thead>
            <tbody>
                <tr class="no-data-message">
                    <td colspan="5">Choose month and type of saving</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="chart-container">
        <canvas id="myChart"></canvas>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const selectElement = document.getElementById('type-saving');
            const csvButton = document.getElementById('csv_button');
            let reportData = [];

            // Fetch options from API
            fetch('/analysis/monthly-report/getTypeAPI')
                .then(response => response.json())
                .then(data => {
                    const existList = new Set();
                    let nonTermAdded = false;

                    data.forEach(option => {
                        const optionTypeLower = option.type.toLowerCase();

                        if (optionTypeLower === 'non-term' && !nonTermAdded) {
                            const optionElement = document.createElement('option');
                            optionElement.value = option.type;
                            optionElement.textContent = option.type;
                            selectElement.appendChild(optionElement);
                            nonTermAdded = true;
                        } else if (!existList.has(optionTypeLower)) {
                            const optionElement = document.createElement('option');
                            optionElement.value = option.type;
                            optionElement.textContent = option.type;
                            selectElement.appendChild(optionElement);
                            existList.add(optionTypeLower);
                        }
                    });
                })
                .catch(error => console.error('Error fetching options:', error));

            // Initialize doughnut chart with the previous month's data
            const currentDate = new Date();
            const previousMonth = new Date(currentDate.setMonth(currentDate.getMonth() - 1));
            const formattedMonth = ('0' + (previousMonth.getMonth() + 1)).slice(-2);
            const year = previousMonth.getFullYear();

            fetch(`/analysis/monthly-report/createReportAPI?month=${encodeURIComponent(formattedMonth)}&year=${encodeURIComponent(year)}&type_of_saving=all`)
                .then(response => response.json())
                .then(data => {
                    let newAccounts = 0;
                    let closedAccounts = 0;

                    data.forEach(item => {
                        newAccounts += item.number_of_new_account;
                        closedAccounts += item.number_of_closed_account;
                    });

                    chart.data.datasets[0].data = [newAccounts, closedAccounts];
                    chart.update();
                })
                .catch(error => console.error('Error initializing chart with previous month data:', error));

            // Event listener for creating the report
            document.getElementById('create').addEventListener('click', function () {
                const monthInput = document.getElementById('month-report').value;
                const typeSaving = document.getElementById('type-saving').value;
                let month, year;

                // Check for different formats and split accordingly
                if (monthInput.includes('-')) {
                    [year, month] = monthInput.split('-');
                }

                // Display month and type of savings
                document.getElementById('month-info').textContent = `Month: ${monthInput}`;
                document.getElementById('type-saving-info').textContent = `Type of Savings: ${typeSaving || '--'}`;

                if (month && year && typeSaving) {
                    fetch(`/analysis/monthly-report/createReportAPI?month=${encodeURIComponent(month)}&year=${encodeURIComponent(year)}&type_of_saving=${encodeURIComponent(typeSaving)}`)
                        .then(response => {
                            if (!response.ok) throw new Error('Network response was not ok');
                            return response.json();
                        })
                        .then(data => {
                            const tbody = document.querySelector('.account-table tbody');
                            tbody.innerHTML = '';  // Clear the table
                            
                            // Clear previous report data and update new report data
                            reportData = [];
                            
                            // Update table and chart with new data
                            let newAccounts = 0;
                            let closedAccounts = 0;

                            data.forEach((item, index) => {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${index + 1}</td>
                                    <td>${item.date}</td>
                                    <td>${item.number_of_new_account}</td>
                                    <td>${item.number_of_closed_account}</td>
                                    <td>${item.difference}</td>
                                `;
                                tbody.appendChild(row);

                                // Store data for CSV export
                                reportData.push({
                                    no: index + 1,
                                    date: item.date,
                                    number_of_new_account: item.number_of_new_account,
                                    number_of_closed_account: item.number_of_closed_account,
                                    difference: item.difference
                                });

                                newAccounts += item.number_of_new_account;
                                closedAccounts += item.number_of_closed_account;
                            });

                            // Enable CSV button after data is added
                            if (reportData.length > 0) {
                                csvButton.disabled = false;
                            }

                            // Update chart data
                            chart.data.datasets[0].data = [newAccounts, closedAccounts];
                            chart.update();
                        })
                        .catch(error => console.error('Error fetching report data:', error));
                } else {
                    alert('Please select both month and type of saving.');
                }
            });

            // Initialize chart with doughnut type
            var ctx = document.getElementById('myChart').getContext('2d');
            var chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['New Accounts', 'Closed Accounts'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#FFA500', '#32CD32']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 25,
                                padding: 25
                            }
                        },
                        title: {
                            display: true,
                            text: 'Monthly account activity',
                            position: 'bottom',
                            font: {
                                size: 20,
                                weight: 400,
                                family: 'Inter'
                            },
                            padding: {
                                top: 10,
                                bottom: 10
                            }
                        }
                    },
                    layout: {
                        padding: 15
                    },
                    cutout: '70%'
                }
            });

            // Handle CSV export functionality
            csvButton.addEventListener('click', function () {
                if (reportData.length > 0) {
                    let csvContent = "data:text/csv;charset=utf-8,";
                    csvContent += "No,Date,Number of New Accounts,Number of Closed Accounts,Difference\n";

                    reportData.forEach(row => {
                        csvContent += `${row.no},${row.date},${row.number_of_new_account},${row.number_of_closed_account},${row.difference}\n`;
                    });

                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", "monthly_report.csv");
                    document.body.appendChild(link);

                    link.click();
                    document.body.removeChild(link);
                }
            });
        });
    </script>
</body>
</html>
